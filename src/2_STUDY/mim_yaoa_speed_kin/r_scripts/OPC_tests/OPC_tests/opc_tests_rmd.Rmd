---
title: "md_summary_contrasts"
author: "Jacob Salminen"
date: "2024-04-19"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages & Setup
```{r}
# install.packages(c("tidyverse","purrr","R.matlab","readxl","dplyr"))
library(readxl);
library(purrr)
library(tidyverse);
library(tibble)
library(knitr);
library(gtsummary)
library(kableExtra)
library(lme4)
```

## GTSUMMARY THEME
``` {r}
# my_theme <-
#   list(
#     "tbl_summary-str:default_con_type" = "continuous2",
#     "tbl_summary-str:continuous_stat" = c(
#       "{median} ({p25} - {p75})",
#       "{mean} ({sd})",
#       "{min} - {max}"
#     ),
#     "tbl_summary-str:categorical_stat" = "{n} / {N} ({p}%)",
#     "style_number-arg:big.mark" = "",
#     "tbl_summary-fn:percent_fun" = function(x) style_percent(x, digits = 3)
#   )
# my_theme <-
#   list()
# gtsummary::set_gtsummary_theme(my_theme)
gtsummary::set_gtsummary_theme(theme_gtsummary_journal("jama"))
# reset_gtsummary_theme()
```

## load table 
```{r} 
# excel_dir <-"M:/jsalminen/GitHub/par_EEGProcessing/src/_data/MIM_dataset/_studies/04162024_MIM_YAOAN89_antsnormalize_iccREMG0p4_powpow0p3_skull0p01/cluster/icrej_5/12/spec_data/group_spec/psd_calcs/fooof_kinematics_table.xlsx";
excel_dir <-"M:/jsalminen/GitHub/par_EEGProcessing/src/_data/MIM_dataset/_studies/04232024_MIM_YAOAN89_antsnormalize_iccREMG0p4_powpow0p3_skull0p01_15mmrej/cluster/icrej_5/12/spec_data/group_spec/psd_calcs/fooof_kinematics_table.xlsx";
eegt <- read_excel(excel_dir,sheet="Sheet1") 
```

## get unique entries 
```{r} 
clusters = unique(eegt$cluster_id);
subjects = unique(eegt$subj_char);
groups = unique(eegt$group_char);
eeg_measures = c('theta_avg_power','alpha_avg_power','beta_avg_power','aperiodic_exp','aperiodic_offset');
```

## get speeds only 
```{r} 
eegt <- filter_at(eegt,vars('cond_char'), any_vars(. %in% c('0.25','0.5','0.75','1.0')))
flat_speeds = unique(eegt$cond_char)
eegt$cond_char <- as.numeric(eegt$cond_char)
```

## get terrains only (if applicable)
``` {r}
# eegt <- filter_at(eegt,vars('cond_char'), any_vars(. %in% c('flat','low','med','high')))
# eegt <- filter_at(eegt,vars('cond_char'), any_vars(. %in% c('high')))
# eegt$terr_ord_speed <- cut(eegt$speed_ms, 4, ordered = TRUE)
```

## convert speeds to ordered & groups to factors 
```{r conversions}
eegt <- mutate(eegt,across(c('group_char'), factor))
eegt$speed_ord <- cut(eegt$cond_char, 4, ordered = TRUE)
eegt <- mutate(eegt,across(c('cond_char'), factor))
head(eegt)
eegt$group_speed_code = paste(eegt$group_char,eegt$cond_char,sep="_")
```

# Cluster Polynomial Constrast Summaries
```{r contrasts tables, echo=FALSE, message=FALSE, results="asis"}
library(gtsummary)
cat('\n\n<!-- -->\n\n')
for (ci in 1:length(clusters)) {
  tmpt <- filter_at(eegt,vars('cluster_id'), any_vars(. %in% clusters[ci]));
  contrasts(tmpt$speed_ord) = contr.poly(4)
  tbl <- tibble(outcome=eeg_measures) %>%
    rowwise() %>%
    mutate(
      tbl = 
        lm(str_glue("{outcome} ~ 1 + speed_ord"), data=tmpt) %>%
        tbl_regression(intercept = TRUE) %>%
        add_significance_stars(
          hide_se = TRUE,
          hide_ci = FALSE) %>%
        list()
      ) %>%
    pull(tbl) %>%
    tbl_merge(tab_spanner=c("**EEG Theta**","**EEG Alpha**","**EEG Beta**","**Aperiodic Exp.**","**Aperiodic Offset**"))
  # t_out <- as_gt(tbl) %>%
  #   gt::tab_header(title=c("Cluster: ",clusters[ci])) %>% 
  #   gt::tab_options(table.layout = "fixed") %>%
  #   gt::as_latex()
  t_out <- as_kable_extra(tbl, format = "latex") %>%
    add_header_above(c("Cluster: ",clusters[ci])) %>%
    kable_styling(latex_options="scale_down")
  # tbl
  cat(knitr::knit_print(t_out));
  cat('\n\n<!-- -->\n\n')
}
```


# THETA T-TESTS
```{r THETA, echo=FALSE, message=FALSE, results="asis"}
library(rstatix)
library(tidyverse)
library(ggpubr)
#
# options(knitr.table.format = "latex")
eegt$group_speed_code = paste(eegt$group_char,eegt$cond_char,sep="_")
#
for (ci in 1:length(clusters)) {
  print(
    tbl <- eegt %>% 
      filter_at(vars('cluster_id'), any_vars(. %in% clusters[ci])) %>%
      select(group_speed_code,alpha_avg_power,theta_avg_power,beta_avg_power,aperiodic_exp,aperiodic_offset,group_char,cond_char) %>%
      mutate(across(c('group_speed_code'), factor)) %>%
      pairwise_t_test(theta_avg_power~group_speed_code,
                      p.adjust.method = "none",
                      paired=FALSE,
                      pool.sd=FALSE,
                      detailed=TRUE) %>%
      select(.y.,group1,group2,n1,n2,statistic,p.adj,p.adj.signif) %>%
      knitr::kable(caption = cat("## Cluster: ",clusters[ci]," Theta Average Power t-tests"),
                   col.names = c("*EEG Var*", "*Group_Speed_1*", "*Group_Speed_2*", "*N1*", "*N2*","*tstat*","*p-value*","*sig."),
                   align = c("l", "l", "l", "c", "c","c","c","c"),
                   digits = 2
                   )
  )
  cat('\n\n<!-- -->\n\n')
}
```
# ALPHA T-TESTS
```{r ALPHA, echo=FALSE, message=FALSE, results="asis"}
#
for (ci in 1:length(clusters)) {
  print(
    tbl <- eegt %>% 
      filter_at(vars('cluster_id'), any_vars(. %in% clusters[ci])) %>%
      select(group_speed_code,alpha_avg_power,theta_avg_power,beta_avg_power,aperiodic_exp,aperiodic_offset,group_char,cond_char) %>%
      mutate(across(c('group_speed_code'), factor)) %>%
      pairwise_t_test(alpha_avg_power~group_speed_code,
                      p.adjust.method = "none",
                      paired=FALSE,
                      pool.sd=FALSE,
                      detailed=TRUE) %>%
      select(.y.,group1,group2,n1,n2,statistic,p.adj,p.adj.signif) %>%
      knitr::kable(caption = cat("## Cluster: ",clusters[ci],"Alpha Average Power t-tests"),
                   col.names = c("*EEG Var*", "*Group_Speed_1*", "*Group_Speed_2*", "*N1*", "*N2*","*tstat*","*p-value*","*sig."),
                   align = c("l", "l", "l", "c", "c","c","c","c"),
                   digits = 2
                   )
  )
  cat('\n\n<!-- -->\n\n')
}
```
# BETA T-TESTS
```{r BETA, echo=FALSE, message=FALSE, results="asis"}
for (ci in 1:length(clusters)) {
  print(
    tbl <- eegt %>% 
      filter_at(vars('cluster_id'), any_vars(. %in% clusters[ci])) %>%
      select(group_speed_code,alpha_avg_power,theta_avg_power,beta_avg_power,aperiodic_exp,aperiodic_offset,group_char,cond_char) %>%
      mutate(across(c('group_speed_code'), factor)) %>%
      pairwise_t_test(beta_avg_power~group_speed_code,
                      p.adjust.method = "none",
                      paired=FALSE,
                      pool.sd=FALSE,
                      detailed=TRUE) %>%
      select(.y.,group1,group2,n1,n2,statistic,p.adj,p.adj.signif) %>%
      knitr::kable(caption = cat("## Cluster: ",clusters[ci],"Beta Average Power t-tests"),
                   col.names = c("*EEG Var*", "*Group_Speed_1*", "*Group_Speed_2*", "*N1*", "*N2*","*tstat*","*p-value*","*sig."),
                   align = c("l", "l", "l", "c", "c","c","c","c"),
                   digits = 2
                   )
  )
  cat('\n\n<!-- -->\n\n')
}
```

# APERIODIC EXPONENT T-TESTS
```{r APEXP, echo=FALSE, message=FALSE, results="asis"}
for (ci in 1:length(clusters)) {
  print(
    tbl <- eegt %>% 
      filter_at(vars('cluster_id'), any_vars(. %in% clusters[ci])) %>%
      select(group_speed_code,alpha_avg_power,theta_avg_power,beta_avg_power,aperiodic_exp,aperiodic_offset,group_char,cond_char) %>%
      mutate(across(c('group_speed_code'), factor)) %>%
      pairwise_t_test(aperiodic_exp~group_speed_code,
                      p.adjust.method = "none",
                      paired=FALSE,
                      pool.sd=FALSE,
                      detailed=TRUE) %>%
      select(.y.,group1,group2,n1,n2,statistic,p.adj,p.adj.signif) %>%
      knitr::kable(caption = cat("## Cluster: ",clusters[ci],"Aperiodic Exponent t-tests"),
                   col.names = c("*EEG Var*", "*Group_Speed_1*", "*Group_Speed_2*", "*N1*", "*N2*","*tstat*","*p-value*","*sig."),
                   align = c("l", "l", "l", "c", "c","c","c","c"),
                   digits = 2
                   )
  )
  cat('\n\n<!-- -->\n\n')
}
```

# THETA WILCOXON TESTS
```{r THETAW, echo=FALSE, message=FALSE, results="asis"}
library(rstatix)
for (ci in 1:length(clusters)) {
  print(
    tbl <- eegt %>% 
      filter_at(vars('cluster_id'), any_vars(. %in% clusters[ci])) %>%
      select(group_speed_code,alpha_avg_power,theta_avg_power,beta_avg_power,aperiodic_exp,aperiodic_offset,group_char,cond_char) %>%
      mutate(across(c('group_speed_code'), factor)) %>%
      pairwise_wilcox_test(theta_avg_power~group_speed_code,
                      p.adjust.method = "none",
                      paired=FALSE,
                      detailed=TRUE) %>%
      select(.y.,group1,group2,n1,n2,statistic,p.adj,p.adj.signif) %>%
      knitr::kable(caption = cat("## Cluster: ",clusters[ci],"Theta Wilcoxon"),
                   col.names = c("*EEG Var*", "*Group_Speed_1*", "*Group_Speed_2*", "*N1*", "*N2*","*Wstat*","*p-value*","*sig."),
                   align = c("l", "l", "l", "c", "c","c","c","c"),
                   digits = 2
                   )
  )
  cat('\n\n<!-- -->\n\n')
}
```
# ALPHA WILCOXON TESTS
```{r ALPHAW, echo=FALSE, message=FALSE, results="asis"}
# library(rstatix)
for (ci in 1:length(clusters)) {
  print(
    tbl <- eegt %>% 
      filter_at(vars('cluster_id'), any_vars(. %in% clusters[ci])) %>%
      select(group_speed_code,alpha_avg_power,theta_avg_power,beta_avg_power,aperiodic_exp,aperiodic_offset,group_char,cond_char) %>%
      mutate(across(c('group_speed_code'), factor)) %>%
      pairwise_wilcox_test(alpha_avg_power~group_speed_code,
                      p.adjust.method = "none",
                      paired=FALSE,
                      detailed=TRUE) %>%
      select(.y.,group1,group2,n1,n2,statistic,p.adj,p.adj.signif) %>%
      knitr::kable(caption = cat("## Cluster: ",clusters[ci],"Alpha Wilcoxon"),
                   col.names = c("*EEG Var*", "*Group_Speed_1*", "*Group_Speed_2*", "*N1*", "*N2*","*Wstat*","*p-value*","*sig."),
                   align = c("l", "l", "l", "c", "c","c","c","c"),
                   digits = 2
                   )
  )
  cat('\n\n<!-- -->\n\n')
}
```
# BETA WILCOXON TESTS
```{r BETAW, echo=FALSE, message=FALSE, results="asis"}
# library(rstatix)
for (ci in 1:length(clusters)) {
  print(
    tbl <- eegt %>% 
      filter_at(vars('cluster_id'), any_vars(. %in% clusters[ci])) %>%
      select(group_speed_code,alpha_avg_power,theta_avg_power,beta_avg_power,aperiodic_exp,aperiodic_offset,group_char,cond_char) %>%
      mutate(across(c('group_speed_code'), factor)) %>%
      pairwise_wilcox_test(beta_avg_power~group_speed_code,
                      p.adjust.method = "none",
                      paired=FALSE,
                      detailed=TRUE) %>%
      select(.y.,group1,group2,n1,n2,statistic,p.adj,p.adj.signif) %>%
      knitr::kable(caption = cat("## Cluster: ",clusters[ci],"Beta Wilcoxon"),
                   col.names = c("*EEG Var*", "*Group_Speed_1*", "*Group_Speed_2*", "*N1*", "*N2*","*Wstat*","*p-value*","*sig."),
                   align = c("l", "l", "l", "c", "c","c","c","c"),
                   digits = 2
                   )
  )
  cat('\n\n<!-- -->\n\n')
}
```

# APERIODIC EXPONENT WILCOXON TESTS
```{r APEXPW, echo=FALSE, message=FALSE, results="asis"}
# library(rstatix)
for (ci in 1:length(clusters)) {
  print(
    tbl <- eegt %>% 
      filter_at(vars('cluster_id'), any_vars(. %in% clusters[ci])) %>%
      select(group_speed_code,alpha_avg_power,theta_avg_power,beta_avg_power,aperiodic_exp,aperiodic_offset,group_char,cond_char) %>%
      mutate(across(c('group_speed_code'), factor)) %>%
      pairwise_wilcox_test(aperiodic_exp~group_speed_code,
                      p.adjust.method = "none",
                      paired=FALSE,
                      detailed=TRUE) %>%
      select(.y.,group1,group2,n1,n2,statistic,p.adj,p.adj.signif) %>%
      knitr::kable(caption = cat("## Cluster: ",clusters[ci],"Aperiodic Exponent wilcoxon"),
                   col.names = c("*EEG Var*", "*Group_Speed_1*", "*Group_Speed_2*", "*N1*", "*N2*","*Wstat*","*p-value*","*sig."),
                   align = c("l", "l", "l", "c", "c","c","c","c"),
                   digits = 2
                   )
  )
  cat('\n\n<!-- -->\n\n')
}
```
# APERIODIC Offset WILCOXON TESTS
```{r APEXPW, echo=FALSE, message=FALSE, results="asis"}
# library(rstatix)
for (ci in 1:length(clusters)) {
  print(
    tbl <- eegt %>% 
      filter_at(vars('cluster_id'), any_vars(. %in% clusters[ci])) %>%
      select(group_speed_code,alpha_avg_power,theta_avg_power,beta_avg_power,aperiodic_exp,aperiodic_offset,group_char,cond_char) %>%
      mutate(across(c('group_speed_code'), factor)) %>%
      pairwise_wilcox_test(aperiodic_offset~group_speed_code,
                      p.adjust.method = "none",
                      paired=FALSE,
                      detailed=TRUE) %>%
      select(.y.,group1,group2,n1,n2,statistic,p.adj,p.adj.signif) %>%
      knitr::kable(caption = cat("## Cluster: ",clusters[ci],"Aperiodic Offset wilcoxon"),
                   col.names = c("*EEG Var*", "*Group_Speed_1*", "*Group_Speed_2*", "*N1*", "*N2*","*Wstat*","*p-value*","*sig."),
                   align = c("l", "l", "l", "c", "c","c","c","c"),
                   digits = 2
                   )
  )
  cat('\n\n<!-- -->\n\n')
}
```

### LOOP through clusters & get ttests
```{r ground truth ttests, echo=FALSE, message=FALSE}
# s1 = c(0.25,0.5,0.75,1.0,0.25,0.25,0.25,0.5,0.5,0.75)
# s2 = c(0.25,0.5,0.75,1.0,0.5,0.75,1.0,0.75,1.0,1.0)
# g1 = c("H1000's","H2000's","H3000's","H1000's","H1000's","H2000's")
# g2 = c("H1000's","H2000's","H3000's","H2000's","H3000's","H3000's")
# invisible(
# for (ci in 1:length(clusters)) {
#   tmpt <- filter_at(table_out,vars('cluster_id'), any_vars(. %in% clusters[ci]));
#   for (mi in 1:length(eeg_measures)) {
#     sidone <- vector(mode="numeric")
#     for (si in 1:length(flat_speeds)) {
#       tsi <- filter_at(tmpt,vars('cond_char'), any_vars(. %in% flat_speeds[si]));
#       for (sj in 1:length(flat_speeds)) {
#         tsj <- filter_at(tmpt,vars('cond_char'), any_vars(. %in% flat_speeds[sj]));
#         gidone <- vector(mode="numeric")
#         if (!any(match(sidone,sj,nomatch=FALSE))) {
#           for (gi in 1:length(groups)) {
#             tgi <- filter_at(tsi,vars('group_char'), any_vars(. %in% groups[gi]));
#             for (gj in 1:length(groups)) {
#               tgj <- filter_at(tsj,vars('group_char'), any_vars(. %in% groups[gj]));
#               if (!any(match(gidone,gj,nomatch=FALSE))) {
#                 if ((gi==gj && si!=sj) || (gi!=gj && si==sj) || (gi!=gj && si!=sj)) {
#                   cat("## EEG Measure: ",eeg_measures[mi]," Speed1: ",flat_speeds[si]," Speed2: ",flat_speeds[sj]," Group1: ",groups[gi]," Group2: ",groups[gj],"\n");
#                   t_out <- t.test(tgi[[eeg_measures[mi]]],tgj[[eeg_measures[mi]]],alternative = c("two.sided"),
#                     mu = 0, paired = FALSE, var.equal = FALSE,
#                     conf.level = 0.95)
#                   print(t_out)
#                 }
#               }
#             }
#           gidone <- append(gidone, gi);
#           }
#         }
#       }
#       sidone <- append(sidone, si);
#     }
#   }
# }
# )
```